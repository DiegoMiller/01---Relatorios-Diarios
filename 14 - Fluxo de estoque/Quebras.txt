--USE [INTRANET]
--GO
--/****** OBJECT:  STOREDPROCEDURE [DBO].[CORRIGE_AJUSTE_INTRANET_ZEUS]    SCRIPT DATE: 01/07/2016 11:20:42 ******/
--SET ANSI_NULLS ON
--GO
--SET QUOTED_IDENTIFIER ON
--GO
---- =============================================
---- AUTOR		      : DIEGO MILLER
---- DATA DE CRIA플O    : 10/11/2015
---- DESCRI플O          : VALIDA플O DE INTEGRA플O DA INTRANET PARA O ZEUS
---- BANCOS UTILIZADOS  : INTRANET E ZEUS_RTG
---- DATAS DE ALTERACAO : 12/11/2015
---- =============================================
---- EXEC INTRANET.DBO.CORRIGE_AJUSTE_INTRANET_ZEUS 1
--ALTER PROC [DBO].[CORRIGE_AJUSTE_INTRANET_ZEUS] 
--@CONSULTA AS INT= 0,@DTA_INI DATE = NULL,@DTA_FIM DATE =NULL

--AS

DECLARE @DTA_INI AS DATE
DECLARE @DTA_FIM AS DATE
DECLARE @CONSULTA BIT = 1

IF @DTA_INI IS NULL BEGIN SET @DTA_INI = '2016-01-01' END
IF @DTA_FIM IS NULL BEGIN SET @DTA_FIM = CAST(GETDATE()-2 AS DATE) END


IF OBJECT_ID('tempdb..#TMP_EAN') IS NOT NULL   

BEGIN
	DROP TABLE #TMP_EAN
END	


IF OBJECT_ID('tempdb..#TEMP_AJUSTE_INTRANET') IS NOT NULL   

BEGIN
	DROP TABLE #TEMP_AJUSTE_INTRANET
END	


IF OBJECT_ID('tempdb..#TEMP_AJUSTE_EFETIVADOS_ZEUS') IS NOT NULL   

BEGIN
	DROP TABLE #TEMP_AJUSTE_EFETIVADOS_ZEUS
END	



SELECT 
		CAST(COD_EAN AS DOUBLE PRECISION) AS COD_EAN, 
		CAST(COD_PRODUTO AS DOUBLE PRECISION) AS COD_PRODUTO 
INTO #TMP_EAN 
FROM ZEUS_RTG.DBO.TAB_CODIGO_BARRA (NOLOCK)

SELECT
		COD_LOJA
		,TIPO AS COD_AJUSTE
		,CAST(COD_PRODUTO AS DOUBLE PRECISION) AS COD_PRODUTO
		,SUM(CAST(QTDE AS DOUBLE PRECISION)) AS QTDE_AJUSTE
		,CAST(DATA AS DATE) DTA_AJUSTE
INTO #TEMP_AJUSTE_INTRANET
FROM 
		[INTRANET].[DBO].[TAB_TRANSFINTERNAS] AS T
INNER JOIN [INTRANET].[DBO].[TAB_TRANSFINTERNAS_PROD] AS P
		ON T.ID =P.IDTRANSF
LEFT JOIN #TMP_EAN AS ZEUS_BARRA (NOLOCK)
		ON CAST(P.COD_EAN AS DOUBLE PRECISION) = CAST(ZEUS_BARRA.COD_EAN AS DOUBLE PRECISION)
WHERE 1=1	
		AND CONVERT(DATE, DATA) >= CONVERT(DATE,@DTA_INI)
		AND CONVERT(DATE, DATA) <= CONVERT(DATE,@DTA_FIM)
		AND STATUS = 7	
GROUP BY
	 COD_LOJA,TIPO, CAST(COD_PRODUTO AS DOUBLE PRECISION),CAST(DATA AS DATE)

SELECT 
		COD_LOJA
		,COD_AJUSTE
		,CAST(COD_PRODUTO AS DOUBLE PRECISION) AS COD_PRODUTO
		,SUM(CAST(QTD_AJUSTE AS DOUBLE PRECISION) ) AS QTD_AJUSTE
		,CAST(DTA_AJUSTE AS DATE) DTA_AJUSTE
INTO #TEMP_AJUSTE_EFETIVADOS_ZEUS
FROM 
		ZEUS_RTG.DBO.TAB_AJUSTE_ESTOQUE WITH (NOLOCK)
WHERE 1=1	
		AND CONVERT(DATE, DTA_AJUSTE) >= CONVERT(DATE,@DTA_INI)
		AND CONVERT(DATE, DTA_AJUSTE) <= CONVERT(DATE,@DTA_FIM)
GROUP BY
	 COD_LOJA,COD_AJUSTE, CAST(COD_PRODUTO AS DOUBLE PRECISION),CAST(DTA_AJUSTE AS DATE)

IF @CONSULTA = 1

		BEGIN

				SELECT 
				INTRANET.*
				,ZEUS.*
				,CASE WHEN TIPO_OPERACAO = 1 THEN  QTDE_AJUSTE *-1 
						WHEN TIPO_OPERACAO = 2 THEN QTDE_AJUSTE *-1
				ELSE QTDE_AJUSTE END - QTD_AJUSTE AS DIF
				FROM #TEMP_AJUSTE_INTRANET AS INTRANET 
				LEFT JOIN ZEUS_RTG.DBO.TAB_TIPO_AJUSTE TIPO
						ON TIPO.COD_AJUSTE = INTRANET.COD_AJUSTE
				LEFT JOIN #TEMP_AJUSTE_EFETIVADOS_ZEUS AS ZEUS 
						ON INTRANET.COD_LOJA = ZEUS.COD_LOJA AND INTRANET.COD_AJUSTE = ZEUS.COD_AJUSTE AND INTRANET.COD_PRODUTO = ZEUS.COD_PRODUTO AND  INTRANET.DTA_AJUSTE = ZEUS.DTA_AJUSTE
				WHERE 1=1
				AND CAST(CASE WHEN TIPO_OPERACAO = 1 THEN  QTDE_AJUSTE *-1 
						WHEN TIPO_OPERACAO = 2 THEN QTDE_AJUSTE *-1
				ELSE QTDE_AJUSTE END -  ISNULL(QTD_AJUSTE,0) AS DECIMAL) <> 0
	

		END
ELSE
		BEGIN

				UPDATE ZEUS
				SET ZEUS.QTD_AJUSTE = CASE WHEN TIPO_OPERACAO = 1 THEN  QTDE_AJUSTE *-1 WHEN TIPO_OPERACAO = 2 THEN QTDE_AJUSTE *-1	ELSE QTDE_AJUSTE END 				
				SELECT *
				FROM #TEMP_AJUSTE_INTRANET AS INTRANET 
				LEFT JOIN ZEUS_RTG.DBO.TAB_TIPO_AJUSTE TIPO
						ON TIPO.COD_AJUSTE = INTRANET.COD_AJUSTE
				LEFT JOIN ZEUS_RTG.DBO.TAB_AJUSTE_ESTOQUE  AS ZEUS 
						ON INTRANET.COD_LOJA = ZEUS.COD_LOJA AND INTRANET.COD_AJUSTE = ZEUS.COD_AJUSTE AND INTRANET.COD_PRODUTO = ZEUS.COD_PRODUTO AND  INTRANET.DTA_AJUSTE = ZEUS.DTA_AJUSTE
				WHERE 1=1
				AND	CAST(CASE WHEN TIPO_OPERACAO = 1 THEN  QTDE_AJUSTE *-1 
						WHEN TIPO_OPERACAO = 2 THEN QTDE_AJUSTE *-1
				ELSE QTDE_AJUSTE END - QTD_AJUSTE AS DECIMAL) <> 0

		END
