(* ::Package:: *)

Needs["Murta`"]
Needs["MAFormat`"]
Needs["MarcheDiego`"]


SetDirectory@mrtFileDirectory[];
$mailsGerencia=marcheGetMailFromXML[];
$logo=Import["Marche.png"];
$lojas={12,13};
$now=DateString[Now,{"Day","/","Month","/","Year"}];
$now2=DateString[DatePlus[-0],{"Day","-","Month","-","Year"}];
$DateOntem=DateString[DatePlus[-1], {"Day", "/", "Month", "/", "Year"}];
$dataIni={2015,01,01};


(* ::Title:: *)
(*DADOS PARA O EXCEL*)


getCustoEntrada[codLoja_]:=Module[{sql,r,conn=marcheConn2[],tab},
sql="  
				SET NOCOUNT ON;

				select distinct max(Dta_Entrada) as Dta_Entrada, COD_PRODUTO, COD_LOJA into #temp from DW.DBO.PRODUTO_CUSTOS_ENTRADA with (nolock)
				where 1=1 
				and cod_loja in (`1`)
				and COD_PRODUTO IN  (222,239,2068,3254,3773,4176,4282,4824,7009,7870,8518,8549,8617,8990,10108,12041,12331,12706,14786,17831,18111,18753,20046,20589,21333,22972,23015,23900,30168,31189,31660,32797,33251,36276,36320,36368,36467,36504,36511,37105,37433,37747,38850,39031,39116,41669,42116,46152,48354,48361,48385,48408,49252,51392,55864,56229,60578,69793,73561,76012,84338,84567,87674,93330,96508,96522,99412,101626,104265,111164,117333,117340,122023,122191,124355,136440,145718,150705,174602,174701,188500,195072,205702,215466,226974,245722,297028,302265,302692,304611,306744,317498,317610,320191,322850,323857,324007,324533,328326,338080,372336,377911,380119,383400,389743,403450,406420,410106,410113,412407,421997,429603,471213,477437,485708,487054,487917,491471,491563,491587,492157,495431,503839,503877,509817,530262,551915,557351,558549,560283,560843,560849,560856,560870,560887,561525,566674,577120,577489,580373,585996,590730,595520,597272,598354,601023,601047,601252,601269,601856,604611,606411,607353,613682,626040,628303,628310,631310,631754,647106,665933,676700,684347,693530,694858,703895,704250,704274,704304,704328,707190,715300,719407,730341,740234,740241,740258,740289,740401,740593,742153,758079,793677,882965,987011,991019,992142,992143,992756,992861,992903,992909,992910,992911,992912,993245,993433,993477,993619,993620,993621,993622,993623,993624,993625,993994,993995,993997,993998,993999,994043,994044,994047,994050,994111,994112,994113,994114,994115,994116,994117,994118,994339,994340,994341,994342,994343,994344,994444,994798,994998,995042,995043,995078,995476,995535,998184,998316,999195,999196,999197,999199,999200,999201,999211,999485,999486,999487,999488,999489,999491,999492,999495,999520,999521,999523,999524,999525,999802,1000136,1000137,1000483,1000864,1000868,1000870,1000881,1001135,1001432,1001484,1001485,1001732,1001733,1001734,1002083,1002084,1002598,1002599,1004035,1004120,1004121,1005104,1007299,1007798,1007799,1007800,1007802,1007811,1007813,1007814,1007815,1007816,1007817,1007818,1007819,1007840,1007841,1007842,1008514,1008515,1008811,1008815,1008922,1008924,1009745,1009753,1013377,1013385,1013413,1014432,1014930,1015148,1015431,1015432,1015601,1016007,1016058,1016330,1016331,1016333,1016814,1016816,1016817,1016826,1016973,1016975,1016999,1017076,1017104,1017161,1017167,1017539,1017588,1017602,1019179,1019183,1019185,1019363,1019383,1019384,1019387,1019396,1020555,1020557,1020765,1020769,1020781,1020784,1021121,1022364,1022763,1022764,1024798,1024809,1025148,1025545,1025555,1025964,1025966,1025967,1026306,1026307,1026308,1026309,1026310,1026570,1026583,1026585,1026598,1026600,1026605,1026850,1026852,1027414,1027445,1027528,1027529,1027530,1027864,1027865,1027866,1027867,1027868,1027869,1027952,1027953,1027969,1027970,1027971,1028203,1028206,1028207,1028387,1028388,1028937,1029451,1030324,1030408,1030541,1030542,1030543,1030544,1030545,1030546,1030547,1030640,1030873,1033571,1033572,1033681,1033682,1033683,1033684,1033685,1033686,1033687,1033688,1033689,1033690,1034477,1034478,1034479,1033681,1033682,1033683,1033684,1033685,1033686,1033687,1033688,1033689,1033690,1034382,1034386,1034387,1034388,1034477,1034478,1034479,1034532,1034533,1034534,1034535,1030560,119948,636513,1030560,1016826,1002599,1002598,329743,1032986)
				group by COD_PRODUTO, COD_LOJA 


				--select * from #temp
				--drop table #temp

				SELECT
				c.COD_LOJA			
				,A.COD_PRODUTO	
				,DESCRICAO
				,NO_DEPARTAMENTO
				,NO_SECAO
				,CAST(	VlrCmv	AS DOUBLE PRECISION)	AS	VlrCmv		
				,uCom	
				,uTrib	
				,PESADO
				,CAST(	qtdEmb	AS DOUBLE PRECISION)	AS	qtdEmb
				,CAST(	qtdRec	AS DOUBLE PRECISION)	AS	qtdRec
				,CAST(	vUnCom	AS DOUBLE PRECISION)	AS	vUnCom
				,CAST(	vProd	AS DOUBLE PRECISION)	AS	vProd
				,CAST(	vDesc	AS DOUBLE PRECISION)	AS	vDesc
				,CAST(	vOutros	AS DOUBLE PRECISION)	AS	vOutros
				,CAST(	qTrib	AS DOUBLE PRECISION)	AS	qTrib
				,CAST(	vUnTrib	AS DOUBLE PRECISION)	AS	vUnTrib
				,CAST(	vlrVenda	AS DOUBLE PRECISION)	AS	vlrVenda
				,CAST(	VlrCustoLiq	AS DOUBLE PRECISION)	AS	VlrCustoLiq
				,CAST(	VlrBaseCreditoIcms	AS DOUBLE PRECISION)	AS	VlrBaseCreditoIcms
				,CAST(	VlrBaseSt	AS DOUBLE PRECISION)	AS	VlrBaseSt
				,CAST(	VlrIcmsSaida	AS DOUBLE PRECISION)	AS	VlrIcmsSaida
				,CAST(	VlrDebitoPisCofins	AS DOUBLE PRECISION)	AS	VlrDebitoPisCofins
				,CAST(	VlrReposicao	AS DOUBLE PRECISION)	AS	VlrReposicao
				,CAST(	VlrCustoLiqIPI	AS DOUBLE PRECISION)	AS	VlrCustoLiqIPI
				,CAST(	VlrDebitoIcms	AS DOUBLE PRECISION)	AS	VlrDebitoIcms
				,SAIDA_ICMS_CST
				,CAST(	vlrIPI	AS DOUBLE PRECISION)	AS	vlrIPI
				,CAST(	VlrCreditoIcms	AS DOUBLE PRECISION)	AS	VlrCreditoIcms
				,CAST(	VlrICMSST	AS DOUBLE PRECISION)	AS	VlrICMSST
				,CAST(	VlrCreditoPisCofins	AS DOUBLE PRECISION)	AS	VlrCreditoPisCofins
				,NUM_DANFE

				,c.Dta_Entrada
				--,RANK() over (partition by cod_loja, a.COD_PRODUTO ORDER BY Dta_Entrada DESC) AS SEQ

				FROM #temp as c 
				left join 
				DW.DBO.PRODUTO_CUSTOS_ENTRADA A WITH (NOLOCK) 
				on c.cod_loja = a.COD_LOJA and c.dta_entrada = a.dta_entrada and c.cod_produto = a.cod_produto
				LEFT JOIN BI.DBO.BI_CAD_PRODUTO B
				ON A.COD_PRODUTO = B.COD_PRODUTO

";
		r\[LeftArrow]mrtSQLDataObject[conn,sql,{SQLArgument@@codLoja}];
		r
];
r\[LeftArrow]getCustoEntrada[$lojas]


(* ::Subtitle:: *)
(*GERANDO ARQUIVOS EM EXCEL*)


SetDirectory@FileNameJoin@{mrtFileDirectory[],"reports"};
$fileName="Ultimos Custos CC "<>$now2<>".xlsx";
Export["Ultimos Custos CC "<>$now2<>".xlsx",r["DataAll"]];


(* ::Title:: *)
(*ENVIANDO EMAIL*)


marcheMail[
  		"\[CapitalUAcute]ltimo Custo Cozinha Central" <>$now
  		,"Anexo planilha contendo os itens e seus respectivos custos (Coluna VlrCmv)"
  		,$mailsGerencia
		  ,{$fileName}
]
